---
version: 0.0.0

# Factories will represent a collection of test data.
# Scenarios are a colletion of test cases that concern some shared topic.
#   - The code being tested is expected to run only 1 time for a scenario.
#   - One run could be associated with multiple scenarios, up to user to decide
# Cases will contain assertions about the results of a run
#  - they can also contain additional conditions about data defined in a scenario

# Identifiers are shared across all scenarios
identifiers:
  # maybe conver this to use keys as names
  - name: student
    attributes:
      - id:
          generator: unique_integer
      - uuid:
          generator: uuid
      - external_id:
          generator: unique_string
          prefix: stu
      - console_id:
          generator: unique_integer

  - name: organization
    attributes:
      - id:
          generator: unique_integer
      - uuid:
          generator: uuid

  - name: pipeline
    attributes:
      - id:
          generator: unique_integer
      - uuid:
          generator: uuid

  - name: generic
    attributes:
      - id:
          generator: unique_integer
      - uuid:
          generator: uuid



factories:
  # name or singular factory?
  - name: CanonicalStudent # Factory names must be unique accross all Factories
    description: Simple easy student

    sources:
      - name: itk_api.students
        data: |
          | id | uuid | organization_id | first_name |
          | -  | -    | -               | -          |
          | s1 | s1   | o1              | Bob        |

        # when a column is marked as an identifier, the values in the table are no longer
        # literal values, but instead are names that can be referenced elsewhere
        identifiers:
          id:
            name: student
            attribute: id
          uuid:
            name: student
            attribute: uuid
          organization_id:
            name: organization
            attribute: id
        # You CANNOT have the same source referenced in multiple factories use different
        # identifiers for a particular column



      - name: itk_api.organizations
        data: |
          | id | uuid |
          | -  | -    |
          | o1 | o1   |
        identifiers:
          id:
            name: organization
            attribute: id
          uuid:
            name: organization
            attribute: uuid

      - name: itk_api.profiles
        data: |
          | id       | student_id |
          | -        | -          |
          | profile1 | s1         |
        identifiers:
          id:
            name: generic
            attribute: id
          student_id:
            name: student
            attribute: id

  - name: StudentWithPipelines
    from:
      - CanonicalStudent

    sources:
      - name: itk_api.pipelines
        data: |
          | id | uuid | student_id |
          | -  | -    | -          |
          | p1 | p1   | s1         |
          | p2 | p2   | s1         |
        identifiers:
          id:
            name: pipeline
            attribute: id
          uuid:
            name: pipeline
            attribute: uuid
          student_id:
            name: student
            attribute: id


# Statics are data that doesn't stack for every test case
# not clear if this is really needed
statics:
  - name: analytics.dimdate
    data: |
      | date       |
      | -          |
      | 2019-01-01 |
      | 2019-01-02 |
      | 2019-01-03 |
      | 2019-01-04 |


scenarios:
  - name: SCStudents
    descriptions: Building the SC student table

    # Factories that get applied for each case in this scenario
    factories:
      - CanonicalStudent

    # retyping the collectors is kinda annoying.... what if they were declared up here
    # Would they be scoped to a scenario or global?
    #   .... wait.... we could scope them at several levels - global, scenario, case
    targets:
      - name: wh.sc_students
        collector:
          field: student_uuid
          identifier: student
          attribute: uuid

    cases:
      - name: It has data
        description: This is the simplest test case for these transformations
        factories: # Factories act as "givens"
          - AnotherOne # I could append case-specific factories to the scenario-wide ones

        expected:
          # Can specify multiple target expectations
          - target: wh.sc_students
            data: |
              | student_uuid      | organization_uuid      |
              | -                 | -                      |
              | {student[1].uuid} | {organization[1].uuid} |
            collector:
              field: student_uuid
              identifier: student
              attribute: uuid


      - name: Full name is a concatenation of first/last name
        factories: # Factories act as "givens"
          - AnotherOne
          # Can also add unnamed factories specific to this case
          - data:
              itk_api.students:
                table: |
                  | id               | uuid              | organization_id      | first_name | last_name |
                  | -                | -                 | -                    | -          | -         |
                  | {student[1].id}  | {student[1].uuid} | {organization[1].id} | Buffy      | Summers   |

        expected:
          - target: wh.sc_students
            data: |
              | student_uuid      | full_name     |
              | -                 | -             |
              | {student[1].uuid} | Buffy Summers |
            by:
              - student_uuid
            collector:
              field: student_uuid
              identifier: student
              attribute: uuid

      - name: Full name is a concatenation of first/last name - alternative identifier method
        factories:
          - data: |
            | id | uuid | organization_id | first_name | last_name |
            | -  | -    | -               | -          | -         |
            | s1 | s1   | o1              | Buffy      | Summers   |

            # It's annoying that the identifiers have already been defined above, do we
            # need to specify them again?
            # Since we're overriding a factory source, maybe we could reuse an identifier if already set?
            #   ^ v2
            identifiers:
              id:
                name: student
                attribute: id
              uuid:
                name: student
                attribute: uuid
              organization_id:
                name: organization
                attribute: id

        expected:
          - target: wh.sc_students
            data: |
              | student_uuid | full_name     |
              | -            | -             |
              | s1           | Buffy Summers |
            by:
              - student_uuid
            # Would also be annoying to specify these in every case.
            # There should be a way to specify (and override) them universally
            identifiers:
              uuid:
                name: student_uuid
                attribute: uuid


  # New scenario for a new set of background data
  #  maybe this is a separate run altogether, up to user to decide
  - name: PSCStudents
    description: Building the PSC student table

    factories:
      - StudentWithPipelines

      targets:
        - name: wh.psc_students
          collector:
            field: student_uuid
            identifier: student
            attribute: uuid

      cases:
        - name: It has data # same name as a case in a different scenario is ok
          expected:
            - target: wh.psc_students
              data: |
                | student_uuid      | pipeline_uuid      |
                | -                 | -                  |
                | {student[1].uuid} | {pipeline[1].uuid} |
                | {student[1].uuid} | {pipeline[2].uuid} |
              by:
                - student_uuid
                - pipeline_uuid








# Schemas may not be required.
# But if a schema is specified, then data sources will include values that are faked

# Seems the primary thing Schemas are doing is being used to fake
# data.  Maybe thatâ€™s not necessary.  I really might be able to keep
# everything as string

# Not sure what value faking random data provides.  User could supply reasonable constants
# for most cases.

schemas:
  - name: itk_api.students
    fields:
      - name: id
        # type should just be JSON types: string, number, json, array, boolean
        #   ^ but maybe add other basics like integer, date, timestamp??
        type: number
        generator: unique_integer # this generator wouldn't be captured like identifiers

      - name: first_name
        type: string
        # no need to specify generator to use default type generator (type=string => generator=string)

      - name: tuituion
        type: number
        # this is started to feel like I need generator arguments
        generator: decimal
        precision: 8
        scale: 2

        # do I need to have type distinct from generator?
        generator:
          type: decimal
          precision: 8
          scale: 2

      - name: enroll_date
        type: date
        generator_args:
          format: %Y%m%d # would I ever need this?


      - name: uuid
        type: string
        generator: uuid
        length: 32 # optional, only needed for very short varchars
        unique: True
        not_null: True

      - name: organization_id
        type: integer
        not_null: True
        foreign_keys:
          - source: itk_api.organizations
            field: id

  - name: itk_api.organizations
    fields:
      - name: id
        type: integer
        unique: True
        not_null: True

      - name: uuid
        type: string
        generator: uuid

  - name: itk_api.profiles
    fields:
      - name: id
        type: integer
        unique: True

      - name: student_id
        type: integer
        foreign_keys:
          - source: itk_api.students
            field: id

      - name: values
        type: string
        generator: json
